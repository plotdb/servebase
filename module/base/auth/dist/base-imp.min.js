var baseImp;function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}baseImp={init:function(t){var e=this,n=t.ctx,o=t.root,r=t.data,u=t.t,s=n.ldview,l=n.ldnotify,d=(n.curegex,n.ldform);return servebase.corectx(function(t){var a=t.core;return function(){var i=this;return this._auth=r.auth,this._auth.get().then(function(t){var e,n,r;i.global=t;i.ldcv=e={};e.authpanel=new ldcover({root:o,zmgr:a.zmgr});e.authpanel.on("toggle.on",function(){return setTimeout(function(){return n.get("username").focus()},100)});i._tab="login";i._info="default";i.view=n=new s({root:o,action:{keyup:{input:function(t){var e,n;e=t.node,n=t.evt;if(n.keyCode===13)return i.submit()}},click:{oauth:function(t){var e;e=t.node;return i._auth.oauth({name:e.getAttribute("data-name")}).then(function(t){debounce(350,function(){return i.info("default")});i.form.reset();i.ldcv.authpanel.set(t);return l.send("success",u("login successfully"))})},submit:function(t){var e;e=t.node;return i.submit()},switch:function(t){var e;e=t.node;return i.tab(e.getAttribute("data-name"))}}},init:{submit:function(t){var e;e=t.node;return i.ldld=new ldloader({root:e})}},handler:{oauths:function(t){var e,n,r;e=t.node;return e.classList.toggle("d-none",!function(){var t,e=[];for(n in t=this.global.oauth){r=t[n];e.push(r)}return e}.call(i).filter(function(t){return t.enabled}).length)},"signin-failed-hint":function(t){var e;e=t.node;return e.classList.toggle("d-none",!i._failedHint)},"signin-failed-hint-text":function(t){var e;e=t.node;return e.innerText=i._failedHintText||""},oauth:function(t){var e;e=t.node;return e.classList.toggle("d-none",!(i.global.oauth[e.getAttribute("data-name")]||{}).enabled)},submit:function(t){var e;e=t.node;return e.classList.toggle("disabled",!i.ready)},"submit-text":function(t){var e;e=t.node;return e.innerText=u(i._tab==="login"?"login":"signup")},displayname:function(t){var e;e=t.node;return e.classList.toggle("d-none",i._tab==="login")},info:function(t){var e,n;e=t.node;n=e.getAttribute("data-name")!==i._info;if(e.classList.contains("d-none")||n)return e.classList.toggle("d-none",n);e.classList.toggle("d-none",true);return setTimeout(function(){return e.classList.toggle("d-none",n)},0)},switch:function(t){var e,n;e=t.node;n=e.getAttribute("data-name");e.classList.toggle("btn-light",i._tab!==n);e.classList.toggle("border",i._tab!==n);return e.classList.toggle("btn-primary",i._tab===n)}}});i.form=r=new d({names:function(){return["username","password","displayname"]},afterCheck:function(t,e){if(t.username!==1&&!i.isValid.username(e.username.value))t.username=2;if(t.password!==1)t.password=!e.password.value?1:!i.isValid.password(e.password.value)?2:0;if(i._tab==="login")return t.displayname=0;else return t.displayname=!e.displayname.value?1:!!e.displayname.value?0:2},root:o});return i.form.on("readystatechange",function(t){i.ready=t;return i.view.render("submit")})})}.apply(e.mod=e.mod(import$({core:a,t:u},n)))})},interface:function(){var n=this;return function(t,e){return null==t&&(t=!0),(e=null==e?{}:e).tab&&n.mod.tab(e.tab),e.lock&&n.mod.ldcv.authpanel.lock(),t?n.mod.ldcv.authpanel.get():n.mod.auth.fetch().then(function(t){return this.mod.ldcv.authpanel.set(t)})}},mod:function(t){var i=t.core,a=(t.ldview,t.ldnotify),e=t.curegex,o=t.t;return{tab:function(t){return/failed/.exec(this._info)&&(this._info="default"),this._tab=t,this.view.render()},isValid:{username:function(t){return e.get("email").exec(t)},password:function(t){return t&&8<=t.length}},info:function(t){return this._info=t,this.view.render("info")},submit:function(){var t,e,n,r=this;if(this.form.ready())return this._failedHint=!1,this.view.render("signin-failed-hint"),t=this.form.values(),(n={}).username=t.username,n.password=t.password,n.displayname=t.displayname,e=n,this.ldld.on().then(function(){return debounce(1e3)}).then(function(){return i.captcha.guard({cb:function(t){return e.captcha=t,ld$.fetch(r._auth.apiRoot()+""+r._tab,{method:"POST"},{json:e,type:"json"})}})}).catch(function(t){return 1005!==lderror.id(t)?Promise.reject(t):ld$.fetch(r._auth.apiRoot()+"reset",{method:"POST"}).then(function(){return r._auth.fetch({renew:!0})}).then(function(){return ld$.fetch(r._auth.apiRoot()+""+r._tab,{method:"POST"},{json:e,type:"json"})})}).then(function(e){return null==e&&(e={}),r._auth.fetch().then(function(t){return e.passwordShouldRenew?i.ldcvmgr.get({name:"@servebase/auth",path:"passwd-renew"}).then(function(){return t}):t})}).finally(function(){return r.ldld.off()}).then(function(t){return debounce(350,function(){return r.info("default")}),r._failedHint=!1,r.view.render(),r.form.reset(),r.ldcv.authpanel.set(t),a.send("success",o("login successfully")),t}).catch(function(t){var e;if(console.log(t),500<=(e=lderror.id(t))&&e<599)return lderror.reject(1007);if(1029===e)return Promise.reject(t);if(1004===e)return r.info("login-exceeded");if(r._failedHintText=o(1014===e?"Account exists. try login":1012===e||1030===e?"Password mismatched":1009===e||1010===e?"Captcha failed":1041===e?"Resource issue":r._tab+" failed"),r.info(r._tab+"-failed"),r._failedHint=!0,r.view.render(),r.form.fields.password.value=null,r.form.check({n:"password",now:!0}),!e||1009===e||1010===e||1041===e)throw t})}}}};
