var baseImp;function import$(e,n){var t,r={}.hasOwnProperty;for(t in n)r.call(n,t)&&(e[t]=n[t]);return e}baseImp={init:function(e){var n=this,t=e.ctx,r=e.root,i=e.data,u=e.t,s=t.ldview,l=t.ldnotify,c=(t.curegex,t.ldform);return servebase.corectx(function(e){var a=e.core;return function(){var o=this;return this._auth=i.auth,this._auth.get().then(function(i){var e,n,t;o.global=i;o.ldcv=e={};e.authpanel=new ldcover({root:r,zmgr:a.zmgr});e.authpanel.on("toggle.on",function(){return setTimeout(function(){return n.get("username").focus()},100)});o._tab="login";o._info="default";o.view=n=new s({root:r,action:{keyup:{input:function(e){var n,t;n=e.node,t=e.evt;if(t.keyCode===13)return o.submit()}},click:{oauth:function(e){var n,t,r;n=e.node;t=((r=i.policy||(i.policy={})).login||(r.login={})).acceptSignup!=="invite"?Promise.resolve():a.ldcvmgr.get({name:"@servebase/auth",path:"invite-token"});return t.then(function(e){e==null&&(e={});return o._auth.oauth({name:n.getAttribute("data-name",{inviteToken:e.inviteToken})})}).then(function(e){debounce(350,function(){return o.info("default")});o.form.reset();o.ldcv.authpanel.set(e);return l.send("success",u("login successfully"))})},submit:function(e){var n;n=e.node;return o.submit()},switch:function(e){var n;n=e.node;return o.tab(n.getAttribute("data-name"))}}},init:{submit:function(e){var n;n=e.node;return o.ldld=new ldloader({root:n})}},handler:{oauths:function(e){var n,t,r;n=e.node;return n.classList.toggle("d-none",!function(){var e,n=[];for(t in e=this.global.oauth){r=e[t];n.push(r)}return n}.call(o).filter(function(e){return e.enabled}).length)},"signin-failed-hint":function(e){var n;n=e.node;return n.classList.toggle("d-none",!o._failedHint)},"signin-failed-hint-text":function(e){var n;n=e.node;return n.innerText=o._failedHintText||""},oauth:function(e){var n;n=e.node;return n.classList.toggle("d-none",!(o.global.oauth[n.getAttribute("data-name")]||{}).enabled)},submit:function(e){var n;n=e.node;return n.classList.toggle("disabled",!o.ready)},"submit-text":function(e){var n;n=e.node;return n.innerText=u(o._tab==="login"?"login":"signup")},displayname:function(e){var n;n=e.node;return n.classList.toggle("d-none",o._tab==="login")},info:function(e){var n,t;n=e.node;t=n.getAttribute("data-name")!==o._info;if(n.classList.contains("d-none")||t)return n.classList.toggle("d-none",t);n.classList.toggle("d-none",true);return setTimeout(function(){return n.classList.toggle("d-none",t)},0)},switch:function(e){var n,t;n=e.node;t=n.getAttribute("data-name");n.classList.toggle("btn-light",o._tab!==t);n.classList.toggle("border",o._tab!==t);return n.classList.toggle("btn-primary",o._tab===t)}}});o.form=t=new c({names:function(){return["username","password","displayname"]},afterCheck:function(e,n){if(e.username!==1&&!o.isValid.username(n.username.value))e.username=2;if(e.password!==1)e.password=!n.password.value?1:!o.isValid.password(n.password.value)?2:0;if(o._tab==="login")return e.displayname=0;else return e.displayname=!n.displayname.value?1:!!n.displayname.value?0:2},root:r});return o.form.on("readystatechange",function(e){o.ready=e;return o.view.render("submit")})})}.apply(n.mod=n.mod(import$({core:a,t:u},t)))})},interface:function(){var t=this;return function(e,n){return null==e&&(e=!0),(n=null==n?{}:n).tab&&t.mod.tab(n.tab),n.lock&&t.mod.ldcv.authpanel.lock(),e?t.mod.ldcv.authpanel.get():t.mod.auth.fetch().then(function(e){return this.mod.ldcv.authpanel.set(e)})}},mod:function(e){var o=e.core,t=(e.ldview,e.ldnotify),n=e.curegex,a=e.t;return{tab:function(e){return/failed/.exec(this._info)&&(this._info="default"),this._tab=e,this.view.render()},isValid:{username:function(e){return n.get("email").exec(e)},password:function(e){return e&&8<=e.length}},info:function(e){return this._info=e,this.view.render("info")},submit:function(){var e,r,n,i=this;if(this.form.ready())return this._failedHint=!1,this.view.render("signin-failed-hint"),e=this.form.values(),(n={}).username=e.username,n.password=e.password,n.displayname=e.displayname,r=n,this.ldld.on().then(function(){return debounce(1e3)}).then(function(){var e=i.global;return"invite"!==((e=e.policy||(e.policy={})).login||(e.login={})).acceptSignup||"signup"!==i._tab?Promise.resolve():o.ldcvmgr.get({name:"@servebase/auth",path:"invite-token"})}).then(function(e){var t;return(t=function(n){return null==n&&(n={}),o.captcha.guard({cb:function(e){return import$((r.captcha=e,r),n.inviteToken?{inviteToken:n.inviteToken}:{}),debounce(250).then(function(){return ld$.fetch(i._auth.apiRoot()+""+i._tab,{method:"POST"},{json:r,type:"json"})})}}).catch(function(n){return 1043!==lderror.id(n)?Promise.reject(n):debounce(250).then(function(){return o.ldcvmgr.get({name:"@servebase/auth",path:"invite-token"}).then(function(e){return e&&e.inviteToken?t({inviteToken:e.inviteToken}):Promise.reject(n)})})})})((e=null==e?{}:e).inviteToken?e:{})}).catch(function(e){return 1005!==lderror.id(e)?Promise.reject(e):ld$.fetch(i._auth.apiRoot()+"reset",{method:"POST"}).then(function(){return i._auth.fetch({renew:!0})}).then(function(){return ld$.fetch(i._auth.apiRoot()+""+i._tab,{method:"POST"},{json:r,type:"json"})})}).then(function(n){return null==n&&(n={}),i._auth.fetch().then(function(e){return n.passwordShouldRenew?o.ldcvmgr.get({name:"@servebase/auth",path:"passwd-renew"}).then(function(){return e}):e})}).finally(function(){return i.ldld.off()}).then(function(e){return debounce(350,function(){return i.info("default")}),i._failedHint=!1,i.view.render(),i.form.reset(),i.ldcv.authpanel.set(e),t.send("success",a("login successfully")),e}).catch(function(e){var n;if(console.log(e),500<=(n=lderror.id(e))&&n<599)return lderror.reject(1007);if(1029===n)return Promise.reject(e);if(1004===n)return i.info("login-exceeded");if(i._failedHintText=a(1014===n?"Account exists. try login":1012===n||1030===n?"Password mismatched":1009===n||1010===n?"Captcha failed":1041===n?"Resource issue":i._tab+" failed"),i.info(i._tab+"-failed"),i._failedHint=!0,i.view.render(),i.form.fields.password.value=null,i.form.check({n:"password",now:!0}),!n||1009===n||1010===n||1041===n)throw e})}}}};
