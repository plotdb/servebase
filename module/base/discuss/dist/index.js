// Generated by LiveScript 1.6.0
(function(){
  var discuss, ref$;
  discuss = function(o){
    var md, markedr;
    o == null && (o = {});
    this.root = typeof o.root === 'string'
      ? document.querySelector(o.root)
      : o.root;
    this.host = o.host || {};
    this.cfg = o.config || {};
    if (typeof marked != 'undefined' && marked !== null) {
      md = new marked.Marked();
      markedr = new marked.Renderer();
      markedr.link = function(href, title, text){
        var link;
        link = marked.Renderer.prototype.link.call(this, href, title, text);
        return link.replace('<a', '<a target="_blank" rel="noopener noreferrer" ');
      };
      md.setOptions({
        renderer: markedr
      });
    }
    this._evthdr = {};
    this._loading = false;
    this._purify = function(t){
      if (typeof DOMPurify != 'undefined' && DOMPurify !== null) {
        return DOMPurify.sanitize(t);
      }
      console.warn("[@servebase/discuss] DOMPurify is not found which is required for DOM sanitizing");
      return t;
    };
    this._md = function(t){
      if ((typeof marked != 'undefined' && marked !== null) && md) {
        return md.parse(t);
      }
      console.warn("[@servebase/discuss] marked is not found which is required for markdown compiling");
      return t;
    };
    this.comments = [];
    this.discuss = {};
    this._uri = o.uri || window.location.pathname;
    this._slug = o.slug || null;
    this._core = o.core;
    this._edit = {
      content: {
        config: {}
      }
    };
    return this;
  };
  discuss.prototype = (ref$ = Object.create(Object.prototype), ref$.on = function(n, cb){
    var this$ = this;
    return (Array.isArray(n)
      ? n
      : [n]).map(function(n){
      var ref$;
      return ((ref$ = this$._evthdr)[n] || (ref$[n] = [])).push(cb);
    });
  }, ref$.fire = function(n){
    var v, res$, i$, to$, ref$, len$, cb, results$ = [];
    res$ = [];
    for (i$ = 1, to$ = arguments.length; i$ < to$; ++i$) {
      res$.push(arguments[i$]);
    }
    v = res$;
    for (i$ = 0, len$ = (ref$ = this._evthdr[n] || []).length; i$ < len$; ++i$) {
      cb = ref$[i$];
      results$.push(cb.apply(this, v));
    }
    return results$;
  }, ref$.isReady = function(){
    return !!(this._edit.content.body || '').trim().length;
  }, ref$.init = function(){
    var this$ = this;
    this.view = this._view({
      root: this.root
    });
    return this._core.init().then(function(){
      return this$._core.auth.get();
    }).then(function(g){
      return this$.g = g;
    });
  }, ref$.load = function(){
    var payload, this$ = this;
    this._loading = true;
    this.view.render();
    this.fire('loading');
    payload = this._slug
      ? {
        slug: this._slug
      }
      : {
        uri: this._uri
      };
    return ld$.fetch('/api/discuss', {
      method: 'GET'
    }, {
      params: payload,
      type: 'json'
    })['finally'](function(){
      return this$.loading = false;
    }).then(function(r){
      this$.comments = r.comments || [];
      this$.discuss = r.discuss || {};
      this$.roles = r.roles || {};
      this$.fire('loaded');
      return this$.view.render();
    });
  }, ref$.contentRender = function(arg$){
    var node, ctx, obj;
    node = arg$.node, ctx = arg$.ctx;
    obj = ctx.content || {};
    if (!(obj.config || {})["renderer"] || !(obj.body != null)) {
      return node.innerText = obj.body || '';
    } else {
      return node.innerHTML = this._purify(this._md(obj.body));
    }
  }, ref$._view = function(arg$){
    var root, setCfg, setAvatar, cfg, this$ = this;
    root = arg$.root;
    setCfg = function(o){
      var k, v, results$ = [];
      o == null && (o = {});
      for (k in o) {
        v = o[k];
        results$.push(this$._edit.content.config[k] = v);
      }
      return results$;
    };
    setAvatar = function(arg$){
      var node, ctx;
      node = arg$.node, ctx = arg$.ctx;
      if (this$.host.avatar) {
        return node.style.background = "url(" + this$.host.avatar({
          comment: ctx || {}
        }) + ")";
      } else {
        return node.style.background = 'auto';
      }
    };
    cfg = {};
    cfg.edit = {
      action: {
        input: {
          input: function(arg$){
            var node, views;
            node = arg$.node, views = arg$.views;
            this$._edit.content.body = node.value;
            return views[0].render('submit');
          }
        },
        click: {
          submit: function(arg$){
            var node, payload;
            node = arg$.node;
            if (node.classList.contains('running')) {
              return;
            }
            if (node.classList.contains('disabled')) {
              return;
            }
            if (!this$.isReady()) {
              return;
            }
            payload = {
              uri: this$._uri,
              content: JSON.parse(JSON.stringify(this$._edit.content)),
              slug: this$._slug
            };
            return this$._core.auth.ensure().then(function(){
              this$.ldld.on();
              return this$._core.captcha.guard({
                cb: function(captcha){
                  payload.captcha = captcha;
                  return ld$.fetch('/api/discuss', {
                    method: payload.key ? 'PUT' : 'POST'
                  }, {
                    type: 'json',
                    json: payload
                  });
                }
              });
            }).then(function(ret){
              return debounce(1000).then(function(){
                return ret;
              });
            }).then(function(ret){
              var c, ref$, ref1$;
              c = (ref$ = (ref1$ = {
                owner: this$._core.user.key,
                createdtime: Date.now(),
                _user: {
                  key: this$._core.user.key,
                  displayname: this$._core.user.displayname
                }
              }, ref1$.uri = payload.uri, ref1$.content = payload.content, ref1$.slug = payload.slug, ref1$), ref$.key = ret.key, ref$.slug = ret.slug, ref$);
              this$.fire('new-comment', c);
              this$.comments.push(c);
              this$._edit.content.body = '';
              this$._edit.preview = false;
              this$.view.get('input').value = '';
              return this$.view.render();
            })['finally'](function(){
              return debounce(1000).then(function(){
                return this$.ldld.off();
              });
            });
          }
        }
      },
      init: {
        submit: function(arg$){
          var node;
          node = arg$.node;
          return this$.ldld = new ldloader({
            root: node
          });
        }
      },
      handler: {
        "@": function(arg$){
          var node;
          node = arg$.node;
          return node.classList.toggle('d-none', !this$.cfg["comment-new"]);
        },
        "toggle-preview": {
          action: {
            input: {
              check: function(arg$){
                var node, views;
                node = arg$.node, views = arg$.views;
                this$._edit.preview = !!node.checked;
                return views[1].render();
              }
            },
            click: {
              label: function(arg$){
                var node, views, input;
                node = arg$.node, views = arg$.views;
                input = views[0].get('check');
                this$._edit.preview = input.checked = !input.checked;
                return views[1].render();
              }
            }
          }
        },
        "use-markdown": {
          action: {
            input: {
              check: function(arg$){
                var node, views, useMarkdown;
                node = arg$.node, views = arg$.views;
                useMarkdown = !!node.checked;
                setCfg({
                  renderer: useMarkdown ? 'markdown' : ''
                });
                return views[1].render();
              }
            },
            click: {
              label: function(arg$){
                var node, views, input, useMarkdown;
                node = arg$.node, views = arg$.views;
                input = views[0].get('check');
                useMarkdown = input.checked = !input.checked;
                setCfg({
                  renderer: useMarkdown ? 'markdown' : ''
                });
                return views[1].render();
              }
            }
          }
        },
        avatar: setAvatar,
        preview: function(arg$){
          var node, revert, state, ref$;
          node = arg$.node;
          revert = in$("off", node.getAttribute('ld').split(" "));
          state = !(ref$ = !(this$._edit.preview && this$._edit.content.config.renderer === 'markdown')) !== !revert && (ref$ || revert);
          return node.classList.toggle('d-none', state);
        },
        panel: function(arg$){
          var node;
          node = arg$.node;
          return this$.contentRender({
            node: node,
            ctx: this$._edit
          });
        },
        submit: function(arg$){
          var node;
          node = arg$.node;
          return node.classList.toggle('disabled', !this$.isReady());
        },
        "if-markdown": function(arg$){
          var node, hidden;
          node = arg$.node;
          hidden = this$._edit.content.config.renderer !== 'markdown';
          return node.classList.toggle('d-none', hidden);
        }
      }
    };
    cfg.discuss = {
      text: {
        "@": function(){
          return (this$.discuss || {}).title || 'untitled';
        }
      }
    };
    cfg.comments = {
      handler: {
        "no-comment": function(arg$){
          var node;
          node = arg$.node;
          return node.classList.toggle('d-none', this$.comments.length);
        },
        comment: {
          list: function(){
            return this$.comments;
          },
          key: function(it){
            return it.key;
          },
          view: {
            text: {
              date: function(arg$){
                var ctx, d;
                ctx = arg$.ctx;
                if (isNaN(d = new Date(ctx.createdtime))) {
                  return '-';
                }
                return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 19).replace('T', ' ');
              },
              author: function(arg$){
                var ctx;
                ctx = arg$.ctx;
                return ctx._user.displayname;
              }
            },
            handler: {
              avatar: setAvatar,
              role: {
                list: function(arg$){
                  var ctx, ret;
                  ctx = arg$.ctx;
                  ret = this$.roles[ctx.owner] || [];
                  return (Array.isArray(ret)
                    ? ret
                    : [ret]).filter(function(it){
                    return it;
                  });
                },
                key: function(it){
                  return it;
                },
                view: {
                  text: {
                    name: function(arg$){
                      var ctx;
                      ctx = arg$.ctx;
                      return ctx;
                    }
                  }
                }
              },
              content: function(o){
                return this$.contentRender({
                  node: o.node,
                  ctx: o.ctx
                });
              }
            }
          }
        }
      }
    };
    return new ldview({
      root: root,
      initRender: false,
      handler: {
        loading: function(arg$){
          var node, names, ref$;
          node = arg$.node, names = arg$.names;
          return node.classList.toggle('d-none', !(!this$._loading !== !(ref$ = in$('off', names)) && (this$._loading || ref$)));
        },
        discuss: cfg.discuss,
        edit: cfg.edit,
        comments: cfg.comments
      }
    });
  }, ref$);
  if (typeof module != 'undefined' && module !== null) {
    module.exports = discuss;
  } else if (typeof window != 'undefined' && window !== null) {
    window.discuss = discuss;
  }
  function in$(x, xs){
    var i = -1, l = xs.length >>> 0;
    while (++i < l) if (x === xs[i]) return true;
    return false;
  }
}).call(this);
