// Generated by LiveScript 1.6.0
(function(){
  var axios, lderror, aux, captcha, fetch, ref$;
  axios = require('axios');
  lderror = require('lderror');
  aux = require('@servebase/backend/aux');
  captcha = function(opt){
    opt == null && (opt = {});
    this.cfg = opt || {};
    this.middleware = this._middleware();
    return this;
  };
  fetch = function(arg$){
    var url, form, p;
    url = arg$.url, form = arg$.form;
    p = axios.post(url, new URLSearchParams(form), {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    return p.then(function(ret){
      return ret.data;
    })['catch'](function(e){
      return rej(e);
    });
  };
  captcha.prototype = (ref$ = Object.create(Object.prototype), ref$.verify = function(req, res, next){
    var obj, e, ref$, cfg;
    obj = req.body && req.body.captcha
      ? req.body.captcha
      : req.fields ? req.fields.captcha : null;
    if (typeof obj === 'string') {
      try {
        obj = JSON.parse(obj);
      } catch (e$) {
        e = e$;
      }
    }
    if (!(obj && obj.token)) {
      return Promise.resolve({
        score: 0,
        verified: false
      });
    }
    if (!((ref$ = obj.name) === 'hcaptcha' || ref$ === 'recaptcha_v3' || ref$ === 'recaptcha_v2_checkbox')) {
      return lderror.reject(1020);
    }
    if (!(cfg = this.cfg[obj.name])) {
      return lderror.reject(1020);
    }
    if (!(!(cfg.enabled != null) || cfg.enabled)) {
      return lderror.reject(1020);
    }
    return captcha.verifier[obj.name](req, res, cfg, obj);
  }, ref$._middleware = function(){
    var this$ = this;
    if (!(this.cfg && (!(this.cfg.enabled != null) || this.cfg.enabled))) {
      return function(req, res, next){
        return next();
      };
    }
    return function(req, res, next){
      return this$.verify(req, res, next).then(function(cap){
        if (!cap.score || cap.score < 0.5) {
          return next(lderror(1009));
        }
        return next();
      })['catch'](function(e){
        return next(e);
      });
    };
  }, ref$);
  captcha.verifier = {
    hcaptcha: function(req, res, config, capobj){
      var p;
      p = fetch({
        url: 'https://hcaptcha.com/siteverify',
        form: {
          secret: config.secret,
          response: capobj.token,
          remoteip: aux.ip(req)
        }
      });
      return p.then(function(data){
        var that;
        return {
          score: data.success
            ? 1
            : (that = data.score) ? that : 0,
          verified: true
        };
      })['catch'](function(){
        return lderror.reject(1010);
      });
    },
    recaptcha_v2_checkbox: function(req, res, config, capobj){
      var p;
      p = fetch({
        url: 'https://www.google.com/recaptcha/api/siteverify',
        form: {
          secret: config.secret,
          response: capobj.token,
          remoteip: aux.ip(req)
        }
      });
      return p.then(function(data){
        var that;
        if (data.success === false) {
          return reject(lderror(1009));
        }
        return {
          score: data.success
            ? 1
            : (that = data.score) ? that : 0,
          verified: true
        };
      })['catch'](function(e){
        return lderror.id(e) === 1009
          ? e
          : lderror.reject(1010);
      });
    },
    recaptcha_v3: function(req, res, config, capobj){
      var p;
      p = fetch({
        url: 'https://www.google.com/recaptcha/api/siteverify',
        form: {
          secret: config.secret,
          response: capobj.token,
          remoteip: aux.ip(req)
        }
      });
      return p.then(function(data){
        var that;
        if (data.success === false) {
          return reject(lderror(1009));
        }
        ({
          score: data.success
            ? 1
            : (that = data.score) ? that : 0,
          verified: true
        });
        return {
          score: data.score,
          verified: true
        };
      })['catch'](function(e){
        return lderror.id(e) === 1009
          ? e
          : lderror.reject(1010);
      });
    }
  };
  module.exports = captcha;
}).call(this);
